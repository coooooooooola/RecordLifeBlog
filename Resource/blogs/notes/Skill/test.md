---
title: test
date: 2023-01-02
tags:
- plugins
categories: Skill
---

# 流量录制回放 ｜ 字节FTF平台
> FTF平台是PDI质量架构团队开发的公司级平台，除平台能力外还接入了流水线质检原子
> 
# 平台功能
> FTF分为系统级和沙箱级，系统级适用于读接口，请求真实调用不会走mock；沙箱级会在写逻辑上做mock，做到不污染线上数据

## 系统级测试
![](%E6%B5%81%E9%87%8F%E5%BD%95%E5%88%B6%E5%9B%9E%E6%94%BE%20%EF%BD%9C%20%E5%AD%97%E8%8A%82FTF%E5%B9%B3%E5%8F%B0/Pasted%20image%2020230712155959.png)
### 配置任务
> 创建一个任务主要包含「回放信息」、「流量筛选」两步

#### Step1. 采集回放信息
![](%E6%B5%81%E9%87%8F%E5%BD%95%E5%88%B6%E5%9B%9E%E6%94%BE%20%EF%BD%9C%20%E5%AD%97%E8%8A%82FTF%E5%B9%B3%E5%8F%B0/Pasted%20image%2020230712160156.png)
- 基本信息配置
  - 任务类型：
    - 自动回归(实时):抓取的线上流量的返回和ppe环境回放的返回做对比
    - DIFFY模式(实时):同时向两个环境发送请求，对这两次返回做对比
  - PSM：服务唯一标识
  - 回放类型：机器回放（ip回放）、域名回放
  - 流量类别：方法选择（接口维度）、FTF用例集（如果选择这个选项，就无需填「采集信息配置」了）
    ![](%E6%B5%81%E9%87%8F%E5%BD%95%E5%88%B6%E5%9B%9E%E6%94%BE%20%EF%BD%9C%20%E5%AD%97%E8%8A%82FTF%E5%B9%B3%E5%8F%B0/Pasted%20image%2020230712162025.png)
  - 版本：覆盖率场景使用，忽略
- 采集信息配置（确定在那些机器上进行数据采集）
  - 集群：默认都是default集群，除非业务在tce中新定义了集群
  - IDC：机房（LF HL LQ等）
  - 环境：全量/小流量
  - 实例名称：ip列表
- 回放信息配置
  - 回放速率：单位QPS，上限10
  - 回放泳道环境：需要回放的下游泳道，字符串类型
  - 回放集群/区域/IDC/机器：同采集配置
  - 对比回放参数：把采集到的流量回放到哪个环节作为对比
这里解决了流量从哪里来，需要回放到哪两个环境做对比的问题（比较常用的是从线上采集，回放到线上和某一个测试环境做diff）

#### Step2. 流量筛选
![](%E6%B5%81%E9%87%8F%E5%BD%95%E5%88%B6%E5%9B%9E%E6%94%BE%20%EF%BD%9C%20%E5%AD%97%E8%8A%82FTF%E5%B9%B3%E5%8F%B0/Pasted%20image%2020230712162221.png)<!-- {"width":544} -->
这一步主要是确定要回放的接口、回放条数，在高级配置中还可以改写流量的参数。方法类型包含读接口、读加写（只支持读），感觉功能有点鸡肋

#### Step3. 确认任务
![](%E6%B5%81%E9%87%8F%E5%BD%95%E5%88%B6%E5%9B%9E%E6%94%BE%20%EF%BD%9C%20%E5%AD%97%E8%8A%82FTF%E5%B9%B3%E5%8F%B0/Pasted%20image%2020230712162510.png)
最终给出任务详情的明细，方便review

### 任务详情
[FTF 任务详情.mov](%E6%B5%81%E9%87%8F%E5%BD%95%E5%88%B6%E5%9B%9E%E6%94%BE%20%EF%BD%9C%20%E5%AD%97%E8%8A%82FTF%E5%B9%B3%E5%8F%B0/FTF%20%E4%BB%BB%E5%8A%A1%E8%AF%A6%E6%83%85.mov)<!-- {"embed":"true"} -->
对比结果消费至关重要，FTF提供了很清晰的可视化界面以及噪音模版策略，极大程度的减少了标记成本。
#### 噪音模板
![](%E6%B5%81%E9%87%8F%E5%BD%95%E5%88%B6%E5%9B%9E%E6%94%BE%20%EF%BD%9C%20%E5%AD%97%E8%8A%82FTF%E5%B9%B3%E5%8F%B0/Pasted%20image%2020230712165048.png)
[噪音模板.mov](%E6%B5%81%E9%87%8F%E5%BD%95%E5%88%B6%E5%9B%9E%E6%94%BE%20%EF%BD%9C%20%E5%AD%97%E8%8A%82FTF%E5%B9%B3%E5%8F%B0/%E5%99%AA%E9%9F%B3%E6%A8%A1%E6%9D%BF.mov)<!-- {"embed":"true"} -->
为每一个接口单独配置噪音模板，支持jsonpath方式的豁免


## 沙箱级测试
> 这个功能在实际业务中应用不多，不是很好用


# 平台架构设计（偏沙箱）
### 整体方案
![](%E6%B5%81%E9%87%8F%E5%BD%95%E5%88%B6%E5%9B%9E%E6%94%BE%20%EF%BD%9C%20%E5%AD%97%E8%8A%82FTF%E5%B9%B3%E5%8F%B0/IMG_2093.jpeg)
![](%E6%B5%81%E9%87%8F%E5%BD%95%E5%88%B6%E5%9B%9E%E6%94%BE%20%EF%BD%9C%20%E5%AD%97%E8%8A%82FTF%E5%B9%B3%E5%8F%B0/IMG_2089.jpeg)
![](%E6%B5%81%E9%87%8F%E5%BD%95%E5%88%B6%E5%9B%9E%E6%94%BE%20%EF%BD%9C%20%E5%AD%97%E8%8A%82FTF%E5%B9%B3%E5%8F%B0/IMG_2108.jpeg)


### 采集侧
#### 运行时采集
![](%E6%B5%81%E9%87%8F%E5%BD%95%E5%88%B6%E5%9B%9E%E6%94%BE%20%EF%BD%9C%20%E5%AD%97%E8%8A%82FTF%E5%B9%B3%E5%8F%B0/IMG_2094.jpeg)
![](%E6%B5%81%E9%87%8F%E5%BD%95%E5%88%B6%E5%9B%9E%E6%94%BE%20%EF%BD%9C%20%E5%AD%97%E8%8A%82FTF%E5%B9%B3%E5%8F%B0/IMG_2095.jpeg)

#### 关联方式
- 关联一个请求完整上下文的方式：基于goroutinId+LogId+SocketFD![[IMG_2099.jpeg]]
- 父子协程委派机制关联方式：修改goroutine结构体新增委派关联（没太懂）![[]]![[IMG_2097.jpeg]]
### 回放侧简介
#### 请求重定向
![](%E6%B5%81%E9%87%8F%E5%BD%95%E5%88%B6%E5%9B%9E%E6%94%BE%20%EF%BD%9C%20%E5%AD%97%E8%8A%82FTF%E5%B9%B3%E5%8F%B0/IMG_2100.jpeg)

#### 流量处理
![](%E6%B5%81%E9%87%8F%E5%BD%95%E5%88%B6%E5%9B%9E%E6%94%BE%20%EF%BD%9C%20%E5%AD%97%E8%8A%82FTF%E5%B9%B3%E5%8F%B0/IMG_2102.jpeg)
![](%E6%B5%81%E9%87%8F%E5%BD%95%E5%88%B6%E5%9B%9E%E6%94%BE%20%EF%BD%9C%20%E5%AD%97%E8%8A%82FTF%E5%B9%B3%E5%8F%B0/IMG_2103.jpeg)
### 应用层简介
#### 流量处理
##### 流量存储
![](%E6%B5%81%E9%87%8F%E5%BD%95%E5%88%B6%E5%9B%9E%E6%94%BE%20%EF%BD%9C%20%E5%AD%97%E8%8A%82FTF%E5%B9%B3%E5%8F%B0/IMG_2104.jpeg)
##### 流量获取
![](%E6%B5%81%E9%87%8F%E5%BD%95%E5%88%B6%E5%9B%9E%E6%94%BE%20%EF%BD%9C%20%E5%AD%97%E8%8A%82FTF%E5%B9%B3%E5%8F%B0/IMG_2105.jpeg)
#### 结果Diff
![](%E6%B5%81%E9%87%8F%E5%BD%95%E5%88%B6%E5%9B%9E%E6%94%BE%20%EF%BD%9C%20%E5%AD%97%E8%8A%82FTF%E5%B9%B3%E5%8F%B0/IMG_2106.jpeg)


# 整体规划
![](%E6%B5%81%E9%87%8F%E5%BD%95%E5%88%B6%E5%9B%9E%E6%94%BE%20%EF%BD%9C%20%E5%AD%97%E8%8A%82FTF%E5%B9%B3%E5%8F%B0/IMG_2109.jpeg)





#200 - code - 编程 / 220 - qualityInfra - 质量架构 / 流量录制回放平台#